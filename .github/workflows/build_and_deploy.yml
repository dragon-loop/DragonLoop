name: Build images and redeploy

on: 
  push:
    branches: 
      - develop
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
  
    steps:
    - name: 'Checkout repo' 
      uses: actions/checkout@master

    - name: 'Docker login'
      uses: azure/docker-login@v1
      with:
        login-server: docker.pkg.github.com/dragon-loop/dragonloop/
        username: ${{ secrets.GITHUB_DOCKER_USERNAME }}
        password: ${{ secrets.GITHUB_PACKAGE_REGISTRY_TOKEN }}

    - name: 'Build and push docker images'
      env:
        COMPOSE_DOCKER_CLI_BUILD: 1
        DOCKER_BUILDKIT: 1
      run: |
        docker-compose -f docker-compose.yml -f docker-compose.prod.yml build
        docker-compose -f docker-compose.yml -f docker-compose.prod.yml push
      
    - name: 'Deploy to swarm'
      uses: appleboy/ssh-action@master
      env:
        DOCKER_STACK_FILE: ${{ secrets.DOCKER_STACK_FILE }}
      with:
        host: ${{ secrets.DOCKER_SWARM_IP }}
        username: ${{ DOCKER_SWARM_USERNAME }}
        key: ${{ secrets.DOCKER_SWARM_PRIVATE_KEY }}
        envs: DOCKER_STACK_FILE
        script : |
          tmpfile=$(mktemp /tmp/stack.XXXXXX.yml)
          echo ${DOCKER_STACK_FILE} > ${tmpfile}
          docker stack deploy -c ${tmpfile} --with-registry-auth --prune
          rm ${tmpfile}

        
